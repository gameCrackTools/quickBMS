#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#ifdef WIN32
    #include <windows.h>
#endif



static unsigned char *neptunia_00402c14 = NULL;



static /*const*/ unsigned char neptunia_dump[] = {
    0x83,0xec,0x14,0x8b,0x44,0x24,0x18,0x8b,0x50,0x0c,0x53,0x55,0x56,0x33,0xdb,0x57,
    0x03,0xd0,0x33,0xff,0x89,0x54,0x24,0x1c,0x89,0x5c,0x24,0x10,0x39,0x58,0x04,0x0f,
    0x86,0x05,0x01,0x00,0x00,0x8d,0x48,0x18,0x89,0x4c,0x24,0x14,0x8d,0x64,0x24,0x00,
    0x8b,0x71,0xf8,0x3b,0xf3,0x0f,0x84,0xd6,0x00,0x00,0x00,0x89,0x1d,0x0c,0x30,0x40,
    0x00,0x89,0x1d,0x08,0x30,0x40,0x00,0xc7,0x05,0x10,0x30,0x40,0x00,0x00,0x01,0x00,
    0x00,0x8b,0x01,0x03,0xc2,0xa3,0x00,0x30,0x40,0x00,0x8b,0x49,0xfc,0x03,0xc8,0x89,
    0x0d,0x04,0x30,0x40,0x00,0xb9,0x00,0x30,0x40,0x00,0xe8,0xe1,0x00,0x00,0x00,0x8b,
    0x0d,0x0c,0x30,0x40,0x00,0x8b,0xd0,0x8b,0x44,0x24,0x2c,0x8d,0x1c,0x07,0x03,0xfe,
    0x8d,0x2c,0x33,0x8b,0x35,0x08,0x30,0x40,0x00,0x89,0x7c,0x24,0x20,0x8b,0x3d,0x00,
    0x30,0x40,0x00,0x89,0x54,0x24,0x18,0x3b,0xdd,0x73,0x64,0xeb,0x03,0x8d,0x49,0x00,
    0x8b,0xc2,0x81,0xfa,0xff,0x00,0x00,0x00,0x76,0x4e,0x8d,0x9b,0x00,0x00,0x00,0x00,
    0x85,0xc9,0x75,0x1b,0x3b,0x3d,0x04,0x30,0x40,0x00,0x73,0x7d,0x0f,0xb6,0x37,0x8b,
    0xd6,0x47,0xb9,0x07,0x00,0x00,0x00,0x81,0xe2,0x80,0x00,0x00,0x00,0xeb,0x0a,0x49,
    0xba,0x01,0x00,0x00,0x00,0xd3,0xe2,0x23,0xd6,0x85,0xd2,0x74,0x09,0x8b,0x04,0x85,
    0x14,0x3c,0x40,0x00,0xeb,0x07,0x8b,0x04,0x85,0x14,0x2c,0x40,0x00,0x3d,0xff,0x00,
    0x00,0x00,0x77,0xbc,0x8b,0x54,0x24,0x18,0x88,0x03,0x43,0x3b,0xdd,0x72,0xa1,0x8b,
    0x54,0x24,0x1c,0x8b,0x7c,0x24,0x20,0x8b,0x44,0x24,0x28,0x8b,0x4c,0x24,0x14,0x33,
    0xdb,0x8b,0x74,0x24,0x10,0x46,0x83,0xc1,0x0c,0x89,0x74,0x24,0x10,0x89,0x4c,0x24,
    0x14,0x3b,0x70,0x04,0x0f,0x82,0x06,0xff,0xff,0xff,0x5f,0x5e,0x5d,0xb8,0x01,0x00,
    0x00,0x00,0x5b,0x83,0xc4,0x14,0xc2,0x08,0x00,0x5f,0x5e,0x5d,0x33,0xc0,0x5b,0x83,
    0xc4,0x14,0xc2,0x08,0x00,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,
    0x56,0x8b,0xf1,0x8b,0x46,0x0c,0x85,0xc0,0x75,0x20,0x8b,0x0e,0x3b,0x4e,0x04,0x72,
    0x02,0x5e,0xc3,0xc7,0x46,0x0c,0x07,0x00,0x00,0x00,0x0f,0xb6,0x01,0x89,0x46,0x08,
    0x25,0x80,0x00,0x00,0x00,0x41,0x89,0x0e,0xeb,0x10,0x8d,0x48,0xff,0xb8,0x01,0x00,
    0x00,0x00,0xd3,0xe0,0x89,0x4e,0x0c,0x23,0x46,0x08,0x55,0x57,0x85,0xc0,0x74,0x2b,
    0x8b,0x7e,0x10,0x8d,0x47,0x01,0x8b,0xce,0x89,0x46,0x10,0xe8,0xb0,0xff,0xff,0xff,
    0x8b,0xce,0x89,0x84,0xbe,0x14,0xfc,0xff,0xff,0xe8,0xa2,0xff,0xff,0xff,0x89,0x84,
    0xbe,0x14,0x0c,0x00,0x00,0x8b,0xc7,0x5f,0x5d,0x5e,0xc3,0x8b,0x2e,0x3b,0x6e,0x04,
    0x72,0x06,0x5f,0x5d,0x33,0xc0,0x5e,0xc3,0x0f,0xb6,0x55,0x00,0x53,0x8b,0x5e,0x0c,
    0x8b,0xcb,0xb8,0x01,0x00,0x00,0x00,0xd3,0xe0,0xbf,0x08,0x00,0x00,0x00,0x2b,0xfb,
    0x8b,0xcf,0x48,0x23,0x46,0x08,0x89,0x56,0x08,0xd3,0xe0,0x8b,0xcb,0xd3,0xea,0x8b,
    0xcf,0xbb,0x01,0x00,0x00,0x00,0xd3,0xe3,0x45,0x89,0x2e,0x8d,0x7b,0xff,0x23,0xfa,
    0x0b,0xf8,0x5b,0x8b,0xc7,0x5f,0x5d,0x5e,0xc3,/*INT3*/ 0xcc };



int (__stdcall *neptunia)(unsigned char *in, unsigned char *out) = NULL;



// anti DEP limitation, allocation is necessary
void *neptunia_alloc(void *dump, int dumpsz) {
    int     pagesz;
    void    *ret;

    pagesz = (dumpsz + 4095) & (~4095); // useful for pages? mah

#ifdef WIN32
    ret = VirtualAlloc(
        NULL,
        pagesz,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);    // write for memcpy
#else
    ret = malloc(pagesz);
    mprotect(
        ret,
        pagesz,
        PROT_EXEC | PROT_WRITE);    // write for memcpy
#endif
    memcpy(ret, dump, dumpsz);
    return(ret);
}



void neptunia_init(void) {
    if(!neptunia) {
        neptunia_00402c14 = calloc(0x2018, 1);

        neptunia = neptunia_alloc(neptunia_dump, sizeof(neptunia_dump));

        #define PATCHIT(X,Y) *(int *)((char *)neptunia + X) = (int)(Y);
        PATCHIT(0x0000003d, neptunia_00402c14 + 0x000003f8) // mov dword ptr [40300C], ebx
        PATCHIT(0x00000043, neptunia_00402c14 + 0x000003f4) // mov dword ptr [403008], ebx
        PATCHIT(0x00000049, neptunia_00402c14 + 0x000003fc) // mov dword ptr [403010], 100
        PATCHIT(0x00000056, neptunia_00402c14 + 0x000003ec) // mov dword ptr [403000], eax
        PATCHIT(0x00000061, neptunia_00402c14 + 0x000003f0) // mov dword ptr [403004], ecx
        PATCHIT(0x00000066, neptunia_00402c14 + 0x000003ec) // mov ecx, 403000
        PATCHIT(0x00000071, neptunia_00402c14 + 0x000003f8) // mov ecx, dword ptr [40300C]
        PATCHIT(0x00000085, neptunia_00402c14 + 0x000003f4) // mov esi, dword ptr [403008]
        PATCHIT(0x0000008f, neptunia_00402c14 + 0x000003ec) // mov edi, dword ptr [403000]
        PATCHIT(0x000000b6, neptunia_00402c14 + 0x000003f0) // cmp edi, dword ptr [403004]
        PATCHIT(0x000000e0, neptunia_00402c14 + 0x00001000) // mov eax, dword ptr [eax*4+403C14]
        PATCHIT(0x000000e9, neptunia_00402c14 + 0x00000000) // mov eax, dword ptr [eax*4+402C14]
        #undef PATCHIT
    }
}

