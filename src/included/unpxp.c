/*
unpxp 0.1
by Luigi Auriemma
e-mail: aluigi@autistici.org
web:    aluigi.org
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#ifdef WIN32
    #include <windows.h>
#endif


static unsigned char unpxp_data[] =
"\x00\x00\x00\x00\x00\x00\x00\x00\x01\x01\x02\x02\x03\x03\x04\x04"
"\x05\x05\x06\x06\x07\x07\x08\x08\x09\x09\x0a\x0a\x0b\x0b\x0c\x0c"
"\x0d\x0d\x0e\x0e\x0f\x0f\x10\x10\x11\x11\x00\x00\x1d\x1d\x1d\x1d"
"\x1c\x1c\x1b\x1b\x1a\x1a\x19\x19\x18\x18\x17\x17\x16\x16\x15\x15"
"\x14\x14\x13\x13\x12\x12\x11\x11\x10\x10\x0f\x0f\x0e\x0e\x0d\x0d"
"\x0c\x0c\x00\x00\xdc\xbc\x86\x00\x01\x00\x00\x00\x09\x00\x00\x00"
"\x11\x00\x00\x00\x19\x00\x00\x00\x21\x00\x00\x00\x31\x00\x00\x00"
"\x41\x00\x00\x00\x61\x00\x00\x00\x81\x00\x00\x00\xc1\x00\x00\x00"
"\x01\x01\x00\x00\x81\x01\x00\x00\x01\x02\x00\x00\x01\x03\x00\x00"
"\x01\x04\x00\x00\x01\x06\x00\x00\x01\x08\x00\x00\x01\x0c\x00\x00"
"\x01\x10\x00\x00\x01\x18\x00\x00\x01\x20\x00\x00\x01\x30\x00\x00"
"\x01\x40\x00\x00\x01\x60\x00\x00\x01\x80\x00\x00\x01\xc0\x00\x00"
"\x01\x00\x01\x00\x01\x80\x01\x00\x01\x00\x02\x00\x01\x00\x03\x00"
"\x01\x00\x04\x00\x01\x00\x06\x00\x01\x00\x08\x00\x01\x00\x0c\x00"
"\x01\x00\x10\x00\x01\x00\x18\x00\x01\x00\x20\x00\x01\x00\x30\x00";

static unsigned char unpxp_dump[] =
"\xb8\x30\x36\x00\x00\xe8\xaa\x06\x00\x00\x89\x84\x24\x2c\x36\x00"
"\x00\x8b\x84\x24\x34\x36\x00\x00\x0f\xb6\x48\x01\x0f\xb6\x50\x02"
"\x53\x8b\x9c\x24\x3c\x36\x00\x00\x55\x56\x0f\xb6\x30\xc1\xe6\x08"
"\x0b\xf1\xc1\xe6\x08\x0b\xf2\x83\xc0\x03\xc1\xe6\x08\x57\x89\x5c"
"\x24\x24\xc7\x84\x24\x38\x24\x00\x00\x13\x00\x00\x00\xc7\x44\x24"
"\x30\x00\x02\x00\x00\xc7\x84\x24\x34\x12\x00\x00\x34\x01\x00\x00"
"\xbf\x18\x00\x00\x00\x89\x44\x24\x14\xa8\x01\x74\x15\x0f\xb6\x08"
"\x0b\xf1\x40\xbf\x20\x00\x00\x00\x89\x44\x24\x14\xeb\x04\x8b\x44"
"\x24\x14\x83\xff\x10\x7f\x21\x0f\xb6\x10\x0f\xb6\x48\x01\xc1\xe2"
"\x08\x0b\xd1\xb9\x10\x00\x00\x00\x2b\xcf\xd3\xe2\x83\xc0\x02\x89"
"\x44\x24\x14\x0b\xf2\x83\xc7\x10\x85\xf6\x79\x6c\x4f\x03\xf6\x83"
"\xff\x10\x7f\x21\x0f\xb6\x10\x0f\xb6\x48\x01\xc1\xe2\x08\x0b\xd1"
"\xb9\x10\x00\x00\x00\x2b\xcf\xd3\xe2\x83\xc0\x02\x89\x44\x24\x14"
"\x0b\xf2\x83\xc7\x10\x8b\xee\x83\xef\x10\xc1\xed\x10\xc1\xe6\x10"
"\x83\xff\x10\x7f\x21\x0f\xb6\x10\x0f\xb6\x48\x01\xc1\xe2\x08\x0b"
"\xd1\xb9\x10\x00\x00\x00\x2b\xcf\xd3\xe2\x83\xc0\x02\x89\x44\x24"
"\x14\x0b\xf2\x83\xc7\x10\x8b\xd6\xc1\xea\x18\xc1\xe5\x08\x0b\xd5"
"\xc1\xe6\x08\x83\xef\x08\xeb\x11\x03\xf6\x8b\xd6\xc1\xea\x17\x42"
"\xc1\xe2\x0a\xc1\xe6\x09\x83\xef\x0a\x83\xff\x10\x89\x54\x24\x28"
"\x7f\x21\x0f\xb6\x28\x0f\xb6\x48\x01\xc1\xe5\x08\x0b\xe9\xb9\x10"
"\x00\x00\x00\x2b\xcf\xd3\xe5\x83\xc0\x02\x89\x44\x24\x14\x0b\xf5"
"\x83\xc7\x10\x4f\x85\xf6\x0f\x89\x7d\x04\x00\x00\x33\xc9\xbd\x10"
"\x00\x00\x00\x03\xf6\x89\x4c\x24\x1c\x2b\xef\x83\xff\x10\x7f\x1f"
"\x0f\xb6\x10\x0f\xb6\x48\x01\xc1\xe2\x08\x0b\xd1\x8b\xcd\xd3\xe2"
"\x8b\x4c\x24\x1c\x83\xc0\x02\x83\xc7\x10\x0b\xf2\x83\xed\x10\x8b"
"\xd6\x03\xf6\xc1\xea\x1d\x03\xf6\x88\x94\x0c\x3c\x24\x00\x00\x41"
"\x03\xf6\x83\xef\x03\x83\xc5\x03\x83\xf9\x13\x89\x4c\x24\x1c\x7c"
"\xba\x8d\x8c\x24\x38\x24\x00\x00\x89\x44\x24\x14\xe8\xf7\x05\x00"
"\x00\x33\xd2\x89\x54\x24\x18\x89\x54\x24\x10\x83\xff\x10\x7f\x25"
"\x8b\x44\x24\x14\x0f\xb6\x28\x0f\xb6\x48\x01\xc1\xe5\x08\x0b\xe9"
"\xb9\x10\x00\x00\x00\x2b\xcf\xd3\xe5\x83\xc0\x02\x89\x44\x24\x14"
"\x0b\xf5\x83\xc7\x10\x8b\xce\xc1\xc1\x0a\x8b\xc1\x25\xff\x03\x00"
"\x00\x0f\xbf\x84\x44\x3c\x26\x00\x00\x85\xc0\x7d\x15\xd1\xc1\x8b"
"\xe9\x83\xe5\x01\x2b\xe8\x0f\xbf\x84\x6c\x3c\x2e\x00\x00\x85\xc0"
"\x7c\xeb\x0f\xb6\x8c\x04\x3c\x24\x00\x00\xd3\xe6\x2b\xf9\x83\xf8"
"\x10\x7d\x13\x88\x44\x14\x34\x42\x89\x54\x24\x10\x85\xc0\x74\x6c"
"\x89\x44\x24\x18\xeb\x66\x8b\xee\x75\x19\xc1\xed\x1e\x03\xf6\x83"
"\xc5\x03\x03\xf6\x83\xef\x02\x85\xed\x7e\x51\x8b\x4c\x24\x18\x55"
"\x51\xeb\x34\x83\xf8\x11\x75\x1c\x03\xf6\xc1\xed\x1d\x03\xf6\x83"
"\xc5\x03\x03\xf6\x83\xef\x03\x85\xed\x7e\x31\x55\x8d\x44\x14\x38"
"\x6a\x00\xeb\x1b\xc1\xed\x19\x83\xc5\x0b\xc1\xe6\x07\x83\xef\x07"
"\x85\xed\x7e\x18\x55\x6a\x00\x8b\x44\x24\x18\x8d\x44\x04\x3c\x50"
"\xe8\x98\x03\x00\x00\x83\xc4\x0c\x01\x6c\x24\x10\x8b\x54\x24\x10"
"\x3b\x54\x24\x30\x0f\x8c\x11\xff\xff\xff\x8d\x4c\x24\x30\xe8\xf5"
"\x04\x00\x00\xc7\x44\x24\x10\x00\x00\x00\x00\x83\xff\x10\x7f\x25"
"\x8b\x44\x24\x14\x0f\xb6\x10\x0f\xb6\x48\x01\xc1\xe2\x08\x0b\xd1"
"\xb9\x10\x00\x00\x00\x2b\xcf\xd3\xe2\x83\xc0\x02\x89\x44\x24\x14"
"\x0b\xf2\x83\xc7\x10\x8b\xce\xc1\xc1\x0a\x8b\xd1\x81\xe2\xff\x03"
"\x00\x00\x0f\xbf\x84\x54\x3c\x26\x00\x00\x85\xc0\x7d\x15\xd1\xc1"
"\x8b\xd1\x83\xe2\x01\x2b\xd0\x0f\xbf\x84\x54\x3c\x2e\x00\x00\x85"
"\xc0\x7c\xeb\x0f\xb6\x8c\x04\x3c\x24\x00\x00\xd3\xe6\x2b\xf9\x83"
"\xf8\x10\x7d\x1a\x8b\x4c\x24\x10\x88\x84\x0c\x38\x12\x00\x00\x41"
"\x89\x4c\x24\x10\x85\xc0\x74\x64\x89\x44\x24\x18\xeb\x5e\x8b\xee"
"\x75\x19\xc1\xed\x1e\x03\xf6\x83\xc5\x03\x03\xf6\x83\xef\x02\x85"
"\xed\x7e\x49\x8b\x4c\x24\x18\x55\x51\xeb\x29\x83\xf8\x11\x75\x11"
"\x03\xf6\xc1\xed\x1d\x03\xf6\x83\xc5\x03\x03\xf6\x83\xef\x03\xeb"
"\x0c\xc1\xed\x19\x83\xc5\x0b\xc1\xe6\x07\x83\xef\x07\x85\xed\x7e"
"\x1b\x55\x6a\x00\x8b\x44\x24\x18\x8d\x84\x04\x40\x12\x00\x00\x50"
"\xe8\x98\x02\x00\x00\x83\xc4\x0c\x01\x6c\x24\x10\x8b\x54\x24\x10"
"\x3b\x94\x24\x34\x12\x00\x00\x0f\x8c\x0e\xff\xff\xff\x8d\x8c\x24"
"\x34\x12\x00\x00\xe8\xef\x03\x00\x00\xb8\x01\x00\x00\x00\x89\x44"
"\x24\x20\x89\x44\x24\x10\x89\x44\x24\x18\x89\x44\x24\x1c\x8b\x44"
"\x24\x28\x8d\x0c\x18\x89\x4c\x24\x2c\x83\xff\x10\x7f\x25\x8b\x44"
"\x24\x14\x0f\xb6\x10\x0f\xb6\x48\x01\xc1\xe2\x08\x0b\xd1\xb9\x10"
"\x00\x00\x00\x2b\xcf\xd3\xe2\x83\xc0\x02\x89\x44\x24\x14\x0b\xf2"
"\x83\xc7\x10\x8b\xc6\xc1\xc0\x0a\x8b\xd0\x81\xe2\xff\x03\x00\x00"
"\x0f\xbf\x94\x54\x34\x02\x00\x00\x85\xd2\x7d\x15\xd1\xc0\x8b\xc8"
"\x83\xe1\x01\x2b\xca\x0f\xbf\x94\x4c\x34\x0a\x00\x00\x85\xd2\x7c"
"\xeb\x0f\xb6\x4c\x14\x34\xd3\xe6\x2b\xf9\x81\xfa\x00\x01\x00\x00"
"\x7d\x08\x88\x13\x43\xe9\x6f\x01\x00\x00\x83\xff\x10\x7f\x25\x8b"
"\x44\x24\x14\x0f\xb6\x28\x0f\xb6\x48\x01\xc1\xe5\x08\x0b\xe9\xb9"
"\x10\x00\x00\x00\x2b\xcf\xd3\xe5\x83\xc0\x02\x89\x44\x24\x14\x0b"
"\xf5\x83\xc7\x10\x8b\xce\xc1\xc1\x0a\x8b\xc1\x25\xff\x03\x00\x00"
"\x0f\xbf\x84\x44\x38\x14\x00\x00\x85\xc0\x7d\x15\xd1\xc1\x8b\xe9"
"\x83\xe5\x01\x2b\xe8\x0f\xbf\x84\x6c\x38\x1c\x00\x00\x85\xc0\x7c"
"\xeb\x0f\xb6\x8c\x04\x38\x12\x00\x00\x8b\x6c\x24\x20\xd3\xe6\x0f"
"\xb6\x8c\x04\x38\x12\x00\x00\x2b\xf9\x83\xf8\x04\x7d\x5f\x85\xc0"
"\x75\x04\x8b\xc5\xeb\x32\x83\xf8\x01\x75\x06\x8b\x44\x24\x10\xeb"
"\x1f\x83\xf8\x02\x75\x06\x8b\x44\x24\x18\xeb\x0c\x8b\x4c\x24\x18"
"\x8b\x44\x24\x1c\x89\x4c\x24\x1c\x8b\x4c\x24\x10\x89\x4c\x24\x18"
"\x89\x6c\x24\x10\x89\x44\x24\x20\x8b\xcb\x2b\xc8\x8a\x09\x88\x0b"
"\x43\x81\xe2\xff\x00\x00\x00\x8b\xcb\x8b\xea\x2b\xc8\x8a\x11\x88"
"\x13\x43\x41\x83\xed\x01\x79\xf5\xe9\x9c\x00\x00\x00\x83\xff\x10"
"\x7f\x25\x8b\x5c\x24\x14\x0f\xb6\x2b\x0f\xb6\x4b\x01\xc1\xe5\x08"
"\x0b\xe9\xb9\x10\x00\x00\x00\x2b\xcf\xd3\xe5\x83\xc3\x02\x89\x5c"
"\x24\x14\x0b\xf5\x83\xc7\x10\x83\xc0\xfc\x8b\xe8\xc1\xfd\x03\x0f"
"\xb6\x8d\x2c\x30\x00\x10\x8b\xde\xd3\xeb\x0f\xb6\x8d\x04\x30\x00"
"\x10\x89\x4c\x24\x1c\xd3\xe6\x2b\xf9\x8b\x4c\x24\x18\x89\x4c\x24"
"\x1c\x8b\x4c\x24\x10\x89\x4c\x24\x18\x8b\x4c\x24\x20\x83\xe3\xf8"
"\x83\xe0\x07\x0b\xc3\x03\x04\xad\x58\x30\x00\x10\x8b\x5c\x24\x24"
"\x89\x4c\x24\x10\x8b\xcb\x2b\xc8\x0f\xb6\x09\x88\x0b\x43\x81\xe2"
"\xff\x00\x00\x00\x8b\xcb\x89\x44\x24\x20\x8b\xea\x2b\xc8\x8a\x11"
"\x88\x13\x43\x41\x83\xed\x01\x79\xf5\x89\x5c\x24\x24\x3b\x5c\x24"
"\x2c\x0f\x82\x12\xfe\xff\xff\xeb\x38\x8b\xcf\x03\xf6\x83\xe1\x07"
"\x74\x05\xd3\xe6\x83\xe7\xf8\x8b\xea\x85\xff\x74\x17\x85\xed\x74"
"\x13\x8b\xce\xc1\xe9\x18\x88\x0b\x83\xef\x08\x43\xc1\xe6\x08\x4d"
"\x85\xff\x75\xe9\x01\x6c\x24\x20\x83\xc4\x0c\x03\xdd\x89\x5c\x24"
"\x24\x8b\x84\x24\x4c\x36\x00\x00\x2b\x44\x24\x28\x89\x84\x24\x4c"
"\x36\x00\x00\x85\xc0\x0f\x8f\x53\xfa\xff\xff\x8b\x8c\x24\x3c\x36"
"\x00\x00\x5f\x5e\x5d\x5b\x81\xc4\x30\x36\x00\x00\xc3\x8b\x54\x24"
"\x0c\x8b\x4c\x24\x04\x85\xd2\x74\x66\x33\xc0\x8a\x44\x24\x08\x84"
"\xc0\x75\x13\x81\xfa\x00\x01\x00\x00\x72\x0b\x83\x3d\x00\x30\x00"
"\x10\x00\x74\x02\xeb\x79\x57\x8b\xf9\x83\xfa\x04\x72\x31\xf7\xd9"
"\x83\xe1\x03\x74\x0c\x2b\xd1\x88\x07\x83\xc7\x01\x83\xe9\x01\x75"
"\xf6\x8b\xc8\xc1\xe0\x08\x03\xc1\x8b\xc8\xc1\xe0\x10\x03\xc1\x8b"
"\xca\x83\xe2\x03\xc1\xe9\x02\x74\x06\xf3\xab\x85\xd2\x74\x0a\x88"
"\x07\x83\xc7\x01\x83\xea\x01\x75\xf6\x8b\x44\x24\x08\x5f\xc3\x8b"
"\x44\x24\x04\xc3\x51\x8d\x4c\x24\x04\x2b\xc8\x1b\xc0\xf7\xd0\x23"
"\xc8\x8b\xc4\x25\x00\xf0\xff\xff\x3b\xc8\x72\x0a\x8b\xc1\x59\x94"
"\x8b\x00\x89\x04\x24\xc3\x2d\x00\x10\x00\x00\x85\x00\xeb\xe9\x55"
"\x8b\xec\x83\xec\x10\x89\x7d\xfc\x8b\x45\x08\x99\x8b\xf8\x33\xfa"
"\x2b\xfa\x83\xe7\x0f\x33\xfa\x2b\xfa\x85\xff\x75\x3c\x8b\x4d\x10"
"\x8b\xd1\x83\xe2\x7f\x89\x55\xf4\x3b\xca\x74\x12\x2b\xca\x51\x50"
"\xe8\x59\x00\x00\x00\x83\xc4\x08\x8b\x45\x08\x8b\x55\xf4\x85\xd2"
"\x74\x45\x03\x45\x10\x2b\xc2\x89\x45\xf8\x33\xc0\x8b\x7d\xf8\x8b"
"\x4d\xf4\xf3\xaa\x8b\x45\x08\xeb\x2e\xf7\xdf\x83\xc7\x10\x89\x7d"
"\xf0\x33\xc0\x8b\x7d\x08\x8b\x4d\xf0\xf3\xaa\x8b\x45\xf0\x8b\x4d"
"\x08\x8b\x55\x10\x03\xc8\x2b\xd0\x52\x6a\x00\x51\xe8\x7e\xff\xff"
"\xff\x83\xc4\x0c\x8b\x45\x08\x8b\x7d\xfc\x8b\xe5\x5d\xc3\x55\x8b"
"\xec\x83\xec\x04\x89\x7d\xfc\x8b\x7d\x08\x8b\x4d\x0c\xc1\xe9\x07"
"\x0f\xef\xc0\xeb\x04\x8d\x24\x24\x90\x0f\x7f\x07\x0f\x7f\x47\x10"
"\x0f\x7f\x47\x20\x0f\x7f\x47\x30\x0f\x7f\x47\x40\x0f\x7f\x47\x50"
"\x0f\x7f\x47\x60\x0f\x7f\x47\x70\x8d\xbf\x80\x00\x00\x00\x49\x75"
"\xd8\x8b\x7d\xfc\x8b\xe5\x5d\xc3\x81\xec\x10\x01\x00\x00\x33\xc0"
"\x53\x55\x56\x8b\xf1\x8b\x1e\x33\xed\x3b\xdd\x57\x89\x44\x24\x10"
"\x89\x44\x24\x14\x89\x44\x24\x18\x89\x44\x24\x1c\x89\x44\x24\x20"
"\x89\x44\x24\x24\x89\x44\x24\x28\x89\x44\x24\x2c\x89\x44\x24\x30"
"\x89\x44\x24\x34\x89\x44\x24\x38\x89\x44\x24\x3c\x89\x44\x24\x40"
"\x89\x44\x24\x44\x89\x44\x24\x48\x89\x44\x24\x4c\x89\x44\x24\x50"
"\x7e\x17\x8d\x4e\x04\x8b\xd3\x90\x0f\xb6\x01\xff\x44\x84\x10\x8d"
"\x44\x84\x10\x41\x83\xea\x01\x75\xef\xb8\x01\x00\x00\x00\x89\x84"
"\x24\x9c\x00\x00\x00\x89\x84\x24\xe0\x00\x00\x00\x8d\x48\x01\x89"
"\x6c\x24\x58\x33\xc0\x8d\x09\x8b\x54\x04\x14\x8b\x7c\x04\x58\x03"
"\xfa\x03\xff\x89\x7c\x04\x5c\x8b\xbc\x04\x9c\x00\x00\x00\x03\xf9"
"\x2b\xca\x89\xbc\x04\xa0\x00\x00\x00\x89\xbc\x04\xe4\x00\x00\x00"
"\x83\xc0\x04\x03\xc9\x83\xf8\x38\x7e\xcd\x85\xdb\x0f\x8e\xc0\x00"
"\x00\x00\xeb\x00\x0f\xb6\x44\x35\x04\x85\xc0\x0f\x84\xa8\x00\x00"
"\x00\x83\xf8\x0a\x8b\x5c\x84\x54\x8d\x4b\x01\x89\x4c\x84\x54\x7f"
"\x38\xb9\x0a\x00\x00\x00\x2b\xc8\xb8\x01\x00\x00\x00\xd3\xe0\xd3"
"\xe3\x85\xc0\x0f\x8e\x80\x00\x00\x00\x8b\xc8\x8b\xc5\x0f\xb7\xd0"
"\x8b\xc2\xc1\xe2\x10\x0b\xc2\xd1\xe9\x8d\xbc\x5e\x04\x02\x00\x00"
"\xf3\xab\x13\xc9\xf3\x66\xab\xeb\x60\x83\xf8\x0b\x8b\x94\x84\x98"
"\x00\x00\x00\x8d\x4a\x01\x89\x8c\x84\x98\x00\x00\x00\x66\x89\xac"
"\x56\x04\x0a\x00\x00\x8b\xc8\x7e\x2f\xf6\xc3\x01\x75\x3b\x8b\xc2"
"\x2b\x84\x8c\xdc\x00\x00\x00\xf7\xda\xd1\xf8\x03\x84\x8c\xd8\x00"
"\x00\x00\x49\x03\x44\x8c\x10\xd1\xfb\x83\xf9\x0b\x66\x89\x94\x46"
"\x04\x0a\x00\x00\x8b\xd0\x7f\xd1\xf6\xc3\x01\x75\x0c\xf7\xda\xd1"
"\xfb\x66\x89\x94\x5e\x04\x02\x00\x00\x45\x3b\x2e\x0f\x8c\x42\xff"
"\xff\xff\x5f\x5e\x5d\x5b\x81\xc4\x10\x01\x00\x00\xc3";

int __cdecl (*unpxp)(unsigned char *in, unsigned char *out, int outsz) = NULL;



// anti DEP limitation! if you apply VirtualAlloc on a static char
// it will cover also the rest of the page included other variables!
void *unpxp_alloc(unsigned char *dump, int dumpsz) {
    int     pagesz;
    void    *ret;

    pagesz = (dumpsz + 4095) & (~4095); // useful for pages? mah

#ifdef WIN32
    ret = VirtualAlloc(
        NULL,
        pagesz,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);    // write for memcpy
#else
    ret = malloc(pagesz);
    mprotect(
        ret,
        pagesz,
        PROT_EXEC | PROT_WRITE);    // write for memcpy
#endif
    memcpy(ret, dump, dumpsz);
    return(ret);
}



void unpxp_init(void) {
    if(unpxp) return;
    unsigned    newoff;
    unsigned char   *func;

    func = (unsigned char *)unpxp_alloc(unpxp_dump, sizeof(unpxp_dump));

    #define PATCHIT(X,Y) \
        newoff = (int)(Y); \
        memcpy(func + X, (void *)&newoff, 4);

    PATCHIT(0x562, unpxp_data + 0x2c)
    PATCHIT(0x56d, unpxp_data + 0x4)
    PATCHIT(0x598, unpxp_data + 0x58)
    PATCHIT(0x65d, unpxp_data)

    #undef PATCHIT

    unpxp = (void *)(func);
}

